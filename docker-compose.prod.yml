version: "3.9"

services:
  backend:
    build: ./backend
    ports:
      - "5901:5901"  # VNC raw
      - "6901:6901"  # noVNC web
    env_file:
      - .env
      - ./backend/.env
    environment:
      - PYTHONUNBUFFERED=1
      - AUTO_ADVANCE_GATES=1
      - AUTO_ADVANCE_TIMEOUT=1.0
    dns:
      - 1.1.1.1
      - 8.8.8.8
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-3s}
      retries: ${HEALTH_CHECK_RETRIES:-3}
      start_period: ${HEALTH_CHECK_START_PERIOD:-10s}
    restart: unless-stopped
    networks:
      - webnet

  frontend-build:
    build: ./frontend
    command: sh -c "npm install && npm run build"
    volumes:
      - frontend_dist:/app/dist
    networks:
      - webnet

  caddy:
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
    env_file: .env
    environment:
      - DOMAIN=${DOMAIN}
      - ACME_EMAIL=${ACME_EMAIL}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - frontend_dist:/srv/frontend:ro
    depends_on:
      backend:
        condition: service_healthy
      frontend-build:
        condition: service_completed_successfully
    restart: unless-stopped
    networks:
      - webnet

volumes:
  caddy_data:
  caddy_config:
  frontend_dist:

networks:
  webnet:
    driver: bridge
