--- playwright_driver.py.orig
+++ playwright_driver.py
@@ -7,6 +7,7 @@
 from datetime import datetime
 from pathlib import Path
 from types import SimpleNamespace
 from playwright.async_api import async_playwright
-import re
+import re
+import asyncio
 from urllib.parse import urlparse, parse_qs
 # ========= ENV & PATHS =========
 if not os.environ.get('DISPLAY'):
@@ -570,6 +571,50 @@
             pass

 async def _is_login_modal_visible(page):
+async def _is_logged_in(page):
+    return await page.evaluate("""
+      () => {
+        const b = document.body;
+        if (!b) return false;
+        const txt = (b.innerText || "");
+        const hi = /早上好|下午好|晚上好/.test(txt);
+        const avatar = document.querySelector('.icbu-login-avatar,[class*="avatar"],a[href*="member"]');
+        const work = document.querySelector('a[href*="work.1688.com"]');
+        return hi || !!avatar || !!work;
+      }
+    """)
+
+async def _wait_offer_ready(page, timeout_ms=15000):
+    sels = ['#mod-detail-bd', '.d-content', '[data-spm*="detail"]']
+    for s in sels:
+        try:
+            await page.locator(s).first.wait_for(state="visible", timeout=timeout_ms)
+            return True
+        except Exception:
+            pass
+    return False
+
+def _mute_console(page):
+    def _on_console(msg):
+        t = msg.type()
+        txt = (msg.text() or "")
+        if ("APLUS" in txt or "autoPageExposeSended" in txt
+            or "Permissions policy violation" in txt
+            or "ScriptProcessorNode is deprecated" in txt):
+            return
+        print(f"[BROWSER:{t}] {txt}")
+    page.on("console", _on_console)
+
 async def _close_overlays(page):
     # đóng vài overlay thường gặp để tránh che click/goto
     for sel in ['.guide-close', '.close-btn', '[aria-label="关闭"]', '.newuser-guide .close', '.pop-close']:
@@ -890,6 +933,7 @@
         page = await context.new_page()

+        _mute_console(page)

         return pw, browser, context, page
     except Exception:
@@ -780,20 +824,6 @@
     # 5) Nếu next_url được truyền cho one-shot mode thì xử lý SAU NÀY
     if next_url and not force_show_login:
         await _goto_with_1688_referer(page, next_url)

     return True
+    # --- after login success & storage_state saved ---
+    try:
+        if await _is_logged_in(page):
+            # Ping Work Home 1 lần để "gỡ guard"
+            try:
+                await page.goto("https://work.1688.com/home/seller.htm", wait_until="domcontentloaded")
+                await page.wait_for_timeout(400)
+            except Exception:
+                pass
+
+            # Nếu có next_url thì điều hướng tới sản phẩm + retry nhẹ
+            if next_url:
+                for _ in range(2):
+                    await page.goto(next_url, wait_until="domcontentloaded")
+                    ok = await _wait_offer_ready(page, timeout_ms=12000)
+                    # Không còn login modal nữa => coi như thành công
+                    try:
+                        modal_visible = await page.locator('#J_LoginBox, .login-box, .login-dialog').first.is_visible(timeout=300)
+                    except Exception:
+                        modal_visible = False
+                    if ok and not modal_visible:
+                        break
+                    await asyncio.sleep(0.5)
+    except Exception as e:
+        print(f"[ensure_login_via_taobao] post-login nav error: {e}")
+
+    return True