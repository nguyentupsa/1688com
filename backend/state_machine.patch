--- state_machine.py.orig
+++ state_machine.py
@@ -30,6 +30,20 @@
 }
 _lock = asyncio.Lock()

+# === Manual gates so FE/operator can confirm before next step ===
+_gates = {}  # name -> asyncio.Event
+
+def _gate(name: str):
+    ev = _gates.get(name)
+    if not ev:
+        ev = asyncio.Event()
+        _gates[name] = ev
+    return ev
+
+def gate_reset(name: str):
+    ev = _gate(name)
+    if ev.is_set():
+        _gates[name] = asyncio.Event()
+
+def gate_open(name: str):
+    _gate(name).set()
+
+async def gate_wait(name: str, timeout: float | None = None):
+    ev = _gate(name)
+    if timeout:
+        await asyncio.wait_for(ev.wait(), timeout=timeout)
+    else:
+        await ev.wait()
+
 # current_session_obj: đối tượng *để app.py truy cập như thuộc tính*
 # (app.py gọi: state_machine.current_session.id / .current_state ...)
 current_session_obj = _SNS(
@@ -111,6 +125,9 @@
 async def _s1_open_product_and_open_chat(page, product_url: str):
     _state["step"] = "S1_OPEN_PRODUCT_AND_OPEN_CHAT"
     _save_session_snapshot()
     await playwright_driver.open_chat_from_product_canonical(page, product_url)
+    # Chờ thấy ô chat trước khi sang S2 để tránh "No chat input found"
+    await playwright_driver.wait_for_chat_ready(page, timeout_s=25)

 async def _s2_send_opener(page, opener_text: str):
     _state["step"] = "S2_SEND_OPENER"
@@ -190,7 +207,7 @@
         # 2) Ensure login
         # 2) Ensure login mà không điều hướng sản phẩm (để S1 xử lý)
         await playwright_driver.ensure_login_via_taobao(
             page,
             timeout_s=300,
-            next_url=None,  # Không điều hướng sản phẩm ở S0
+            next_url=None,
             force_show_login=True
         )

@@ -214,6 +231,24 @@
         # 3) Product + Chat
         await _s1_open_product_and_open_chat(page, product_url)

+        # Gate sau khi vào sản phẩm và mở chat
+        _state["step"] = "S1_DONE"
+        _save_session_snapshot()
+        gate_reset("CONFIRM_PRODUCT_AND_CHAT")
+        await gate_wait("CONFIRM_PRODUCT_AND_CHAT", timeout=120)
+
+        # 4) Send opener
         await _s2_send_opener(page, opener_text)

+        # Gate sau khi gửi opener
+        _state["step"] = "S2_DONE"
+        _save_session_snapshot()
+        gate_reset("CONFIRM_AFTER_SEND")
+        await gate_wait("CONFIRM_AFTER_SEND", timeout=60)
+
         # 5) Wait reply
         await _s3_wait_reply(page)

@@ -441,6 +476,9 @@
     start_login_only=start_login_only,
     goto_product=goto_product,
     # Gate functions for manual control
+    gate_open=gate_open,
+    gate_reset=gate_reset,
+    gate_wait=gate_wait,
     open_gate=open_gate,
     reset_gate=reset_gate,
 )