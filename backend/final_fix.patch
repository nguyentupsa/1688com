--- playwright_driver.py.orig
+++ playwright_driver.py
@@ -8,6 +8,8 @@
 from playwright.async_api import async_playwright
 import re
 from urllib.parse import urlparse, parse_qs
 import logging
+import re
+import asyncio
 # ========= ENV & PATHS =========
 if not os.environ.get('DISPLAY'):
     os.environ['DISPLAY'] = ':99'
@@ -22,6 +24,20 @@
 LOGIN_JUMP_ROUTE = "**/_____tmd_____/page/login_jump**"

 # Global flag to control tab closing during login
+_CLOSE_NEW_TABS_DURING_LOGIN = False
+
+logger = logging.getLogger(__name__)
+
 # --- add near the top of file ---
 LOGIN_SELECTORS = [
     'text=立即登录',                 # nút cam ở panel phải / góc phải dưới
     'text=登录',                    # header nhỏ
@@ -32,6 +48,65 @@
     'a[href*="login.1688.com"]',
     'a[href*="login.taobao.com"]',
     'div._buttonWrap_1p2az_60 img[src*="O1CN01ZaHib31lWomw16ded"]'  # nút bạn chỉ định
 ]
+
+# --- add once in your browser/page setup before goto 1688 ---
+def _mute_console(page):
+    def _on_console(msg):
+        t = msg.type()
+        txt = (msg.text() or "").strip()
+        # bỏ qua noise analytics/sensor
+        if ("APLUS" in txt
+            or "autoPageExposeSended" in txt
+            or "Permissions policy violation" in txt
+            or "ScriptProcessorNode is deprecated" in txt
+            or "current-password" in txt
+            or "[endGroup] Error" in txt):
+            return
+        print(f"[BROWSER:{t}] {txt}")
+    page.on("console", _on_console)
+
+async def _block_analytics(page):
+    # chặn request log/analytics/plugin rác để bớt nháy
+    patterns = [
+        r"aplus\.", r"acookie", r"log\.aliyun", r"/aplus_",
+        r"/logstore", r"/spm_log", r"/monitor", r"chromePlugin",
+        r"google-analytics", r"facebook\\.com/tr", r"doubleclick"
+    ]
+    async def _route(route, req):
+        url = req.url
+        if any(re.search(p, url) for p in patterns):
+            return await route.abort()
+        return await route.continue_()
+    await page.route("**/*", _route)
+
 async def _is_login_modal_visible(page):
     sels = ['#J_LoginBox', '.login-box', '.login-dialog', '[id*="login"][class*="dialog"]']
     for s in sels:
@@ -55,6 +130,11 @@
     return False

 async def _is_logged_in(page):
-    # Heuristic: có avatar/nickname/ô vào "工作台"
-    return await page.evaluate("""
-      () => {
-        const txt = document.body.innerText || "";
-        const hasHi = txt.includes("早上好") || txt.includes("下午好") || txt.includes("晚上好");
-        const hasAvatar = document.querySelector('.icbu-login-avatar, [class*="avatar"], [href*="member"]');
-        const hasWork = document.querySelector('a[href*="work.1688.com"]');
-        return hasHi || !!hasAvatar || !!hasWork;
-      }
-    """)
+    return await page.evaluate("""
+      () => {
+        const b = document.body;
+        if (!b) return false;
+        const txt = (b.innerText || "");
+        const hi = /早上好|下午好|晚上好/.test(txt);
+        const avatar = document.querySelector('.icbu-login-avatar,[class*="avatar"],a[href*="member"]');
+        const work = document.querySelector('a[href*="work.1688.com"]');
+        return hi || !!avatar || !!work;
+      }
+    """)

 async def _wait_login_settled(page, settle_ms=800, max_s=40):
     end = asyncio.get_event_loop().time() + max_s
@@ -75,6 +155,30 @@
         await asyncio.sleep(0.2)
     return False

+async def _wait_offer_ready(page, timeout_ms=15000):
+    sels = ['#mod-detail-bd', '.d-content', '[data-spm*="detail"]']
+    for s in sels:
+        try:
+            await page.locator(s).first.wait_for(state="visible", timeout=timeout_ms)
+            return True
+        except Exception:
+            pass
+    return False
+
+async def _after_login_continue(page, next_url: str | None):
+    # 1) ping Work Home 1 lần để "gỡ guard"
+    try:
+        await page.goto("https://work.1688.com/home/seller.htm", wait_until="domcontentloaded")
+        await page.wait_for_timeout(400)
+    except Exception:
+        pass
+
+    if not next_url:
+        return
+
+    # 2) tới sản phẩm + retry 1 lần nếu rớt
+    for attempt in range(2):
+        await page.goto(next_url, wait_until="domcontentloaded")
+        ok = await _wait_offer_ready(page, timeout_ms=12000)
+        if ok and not await _is_login_modal_visible(page):
+            return True
+        await asyncio.sleep(500/1000.0)
+    return False
+
 async def _close_overlays(page):
     # đóng vài overlay thường gặp để tránh che click/goto
     for sel in ['.guide-close', '.close-btn', '[aria-label="关闭"]', '.newuser-guide .close', '.pop-close']:
@@ -592,6 +696,9 @@
 async def ensure_login_via_taobao(page, timeout_s: int = 300, next_url: str | None = None, force_show_login: bool = False):
     """
     Login 1688 ổn định: vào 1688.com -> click 登录 -> popup ->
     login thành công -> gỡ guard -> về Work Home (1 lần duy nhất).
     """
+    # chống mở tab bậy + mute log
+    page.on("popup", lambda p: asyncio.create_task(p.close()))
+    await page.add_init_script("window.open = () => null;")
+    _mute_console(page)
+    await _block_analytics(page)
+
     WORK_HOME = "https://work.1688.com/?tracelog=login_target_is_blank_1688"
     ctx = page.context

@@ -714,6 +821,21 @@
     await page.goto("https://www.1688.com/", wait_until="domcontentloaded")

+    # hiện modal nếu chưa login
+    if force_show_login or not await _is_logged_in(page):
+        try:
+            btn = page.locator('button:has-text("登录"), a:has-text("登录"), text=登录').first
+            if await btn.is_visible(timeout=1500):
+                await btn.click()
+        except Exception:
+            pass
+
+        ok = await _wait_login_settled(page, settle_ms=900, max_s=min(60, timeout_s))
+        if not ok:
+            return {"ok": False, "reason": "login_not_settled"}
+
+    # lưu session
+    try:
+        await page.context.storage_state(path="state.json")
+    except Exception:
+        pass
+
+    # watchdog: nếu vẫn ở homepage > 2s thì tự đi tiếp
+    async def _watchdog():
+        await asyncio.sleep(2.0)
+        try:
+            host = await page.evaluate("location.host")
+            if "1688.com" in host:
+                await _after_login_continue(page, next_url)
+        except Exception:
+            pass
+
+    asyncio.create_task(_watchdog())
+
+    # nếu có next_url, đi ngay (song song watchdog)
+    if next_url:
+        await _after_login_continue(page, next_url)
+
+    return {"ok": True}
+
 async def wait_for_chat_ready(page, timeout_s: int = 25):
     sels = [
         'textarea','[contenteditable="true"]','div[role="textbox"]',
@@ -1049,7 +1171,7 @@
         page = await context.new_page()

-        page.on("console", lambda msg: (
-            None if any(k in msg.text() for k in NOISY) else print(f"[BROWSER:{msg.type()}] {msg.text()}")
-        ))
+        _mute_console(page)

         return pw, browser, context, page
     except Exception:
@@ -1236,6 +1358,7 @@
     wait_for_supplier_reply_canonical=wait_for_supplier_reply_canonical,
     wait_for_chat_ready=wait_for_chat_ready,
     normalize_1688_product_url=normalize_1688_product_url,
     stable_goto_with_referer=stable_goto_with_referer,
+    ensure_chat_ready=ensure_chat_ready,
+    _wait_offer_ready=_wait_offer_ready,
+    _after_login_continue=_after_login_continue,
 )