--- state_machine.py.orig
+++ state_machine.py
@@ -8,6 +8,8 @@
 from types import SimpleNamespace as _SNS

 from playwright_driver import playwright_driver
+import logging
+import asyncio

 # ============== Paths & Data dirs ==============
 DATA_DIR = Path("/app/data")
@@ -30,6 +32,8 @@
 }
 _lock = asyncio.Lock()

+logger = logging.getLogger(__name__)
+
 # === Manual gates so FE/operator can confirm before next step ===
 _gates = {}  # name -> asyncio.Event

@@ -190,6 +194,40 @@
         # 2) Ensure login mÃ  khÃ´ng Ä‘iá»u hÆ°á»›ng sáº£n pháº©m (Ä‘á»ƒ S1 xá»­ lÃ½)
         offer_url = playwright_driver.normalize_1688_product_url(product_url)
+        logger.info(f"[STATE] Starting login process for product: {offer_url}")

+        res = await playwright_driver.ensure_login_via_taobao(page, timeout_s=300, next_url=offer_url)
+        logger.info(f"[STATE] Login result: {res}")
+
+        if not res.get("ok"):
+            logger.error(f"[STATE] Login failed: {res.get('reason', 'Unknown reason')}")
+            await _emit_log("âš ï¸ Login chÆ°a á»•n Ä‘á»‹nh. Vui lÃ²ng hoÃ n táº¥t Ä‘Äƒng nháº­p rá»“i báº¥m Retry.",
+                           phase="blocked", need_user_action=True)
+            raise RuntimeError(f"Login not settled: {res.get('reason', 'Unknown reason')}")

+        await _emit_log("âœ… Login settled â€” navigating to offerâ€¦", phase="discover")
+
+        # xÃ¡c nháº­n tháº­t sá»± á»Ÿ trang sáº£n pháº©m (Ä‘á»£i selector)
+        ok_offer = await playwright_driver._wait_offer_ready(page, timeout_ms=15000)
+        if not ok_offer:
+            await _emit_log("âŸ³ Offer chÆ°a sáºµn sÃ ng, Ä‘ang reload 1 láº§nâ€¦", phase="recover")
+            await page.reload(wait_until="domcontentloaded")
+            ok_offer = await playwright_driver._wait_offer_ready(page, timeout_ms=12000)
+
+        if not ok_offer:
+            await _emit_log("âŒ KhÃ´ng vÃ o Ä‘Æ°á»£c trang sáº£n pháº©m. Xin hÃ£y má»Ÿ thá»§ cÃ´ng trang sáº£n pháº©m rá»“i báº¥m Resume.",
+                           phase="blocked", need_user_action=True)
+            raise RuntimeError("Product page not ready")

+        await _emit_log("ğŸŸ  Offer ready. Äang má»Ÿ khung chatâ€¦", phase="discover")

         # 3) Product + Chat
         # Tá»« Ä‘Ã¢y tiáº¿p tá»¥c open chat / nháº­p tin nháº¯nâ€¦
         ok_chat = await playwright_driver.ensure_chat_ready(page=page, max_s=15)
+        logger.info(f"[STATE] Chat ready check result: {ok_chat}")

         if not ok_chat:
-            logger.error("No chat input found â€” è¯·ç‚¹å‡»è¿›å…¥åº—é“ºèŠå¤©/æˆ–åˆ·æ–°é¡µé¢")
-            raise RuntimeError("Chat not ready")
+            return
+            # await _emit_log("ğŸ›‘ KhÃ´ng tháº¥y Ã´ chat. HÃ£y click 'è”ç³»ä¾›åº”å•†/æ—ºæ—ºèŠå¤©' rá»“i báº¥m Resume.",
+            #                phase="blocked", need_user_action=True)
+            # return

+        await _emit_log("ğŸŸ¢ Chat ready. Opening chat interfaceâ€¦", phase="discover")

         await _s1_open_product_and_open_chat(page, product_url)
+        logger.info("[STATE] S1: Product and chat completed")

@@ -215,6 +253,12 @@
         # 6) Persist storage state
         await playwright_driver.persist_state(_state["_context"])

+        logger.info("[STATE] Negotiation flow completed successfully")
+        return {"session_id": _state["session_id"], "status": _state["status"], "reply": _state["reply"]}
+
     except Exception as e:
+        logger.error(f"[STATE] Error in negotiation flow: {type(e).__name__}: {str(e)}")
+        import traceback
+        logger.debug(f"[STATE] Full traceback:\n{traceback.format_exc()}")
         _state["status"] = "error"
         _state["last_error"] = f"{type(e).__name__}: {e}"
         _state["finished_at"] = datetime.utcnow().isoformat() + "Z"
         _save_session_snapshot()
         raise

+async def _emit_log(message: str, phase: str = "info", need_user_action: bool = False):
+    """Helper to emit structured logs"""
+    log_entry = {
+        "message": message,
+        "phase": phase,
+        "need_user_action": need_user_action,
+        "timestamp": datetime.utcnow().isoformat() + "Z"
+    }
+
+    # Emit to WebSocket if available
+    try:
+        from app import manager
+        import json
+        await manager.broadcast(json.dumps(log_entry))
+    except Exception:
+        pass
+
+    # Also log to console
+    level = "WARNING" if need_user_action else "INFO"
+    logger.info(f"[{phase.upper()}] {message}")
+
 # ============== Public API expected by app.py ==============
 async def start(product_url: str, opener_text: str, max_turns: int = 6, style: str = "Aggressive"):
     """Báº¯t Ä‘áº§u 1 phiÃªn thÆ°Æ¡ng lÆ°á»£ng (one-shot)."""
+    logger.info(f"[STATE] Starting negotiation - Product: {product_url}, Style: {style}")
+
     async with _lock:
         if _state["status"] == "running":
+            logger.warning("[STATE] Another session is already running")
             raise RuntimeError("A session is already running")