--- state_machine.py.orig
+++ state_machine.py
@@ -190,6 +190,12 @@
         # 2) Ensure login mà không điều hướng sản phẩm (để S1 xử lý)
         offer_url = playwright_driver.normalize_1688_product_url(product_url)
+        logger.info(f"[STATE] Starting login process for product: {offer_url}")
+
         res = await playwright_driver.ensure_login_via_taobao(page, timeout_s=300, next_url=offer_url)
+        logger.info(f"[STATE] Login result: {res}")
+
         if not res.get("ok"):
+            logger.error(f"[STATE] Login failed: {res.get('reason', 'Unknown reason')}")
             import logging
             logger = logging.getLogger(__name__)
             logger.error("Login not settled — please finish login then press Retry")
             raise RuntimeError(f"Login not settled: {res.get('reason', 'Unknown reason')}")

@@ -199,6 +205,7 @@
         # 3) Product + Chat
         # Từ đây tiếp tục open chat / nhập tin nhắn…
         ok_chat = await playwright_driver.ensure_chat_ready(page=page, max_s=15)
+        logger.info(f"[STATE] Chat ready check result: {ok_chat}")

         if not ok_chat:
             logger.error("No chat input found — 请点击进入店铺聊天/或刷新页面")
             raise RuntimeError("Chat not ready")
@@ -208,6 +215,11 @@
         # 6) Persist storage state
         await playwright_driver.persist_state(_state["_context"])

+        logger.info("[STATE] Negotiation flow completed successfully")
+        return {"session_id": _state["session_id"], "status": _state["status"], "reply": _state["reply"]}
+
     except Exception as e:
+        logger.error(f"[STATE] Error in negotiation flow: {type(e).__name__}: {str(e)}")
+        import traceback
+        logger.debug(f"[STATE] Full traceback:\n{traceback.format_exc()}")
         _state["status"] = "error"
         _state["last_error"] = f"{type(e).__name__}: {e}"
         _state["finished_at"] = datetime.utcnow().isoformat() + "Z"
         _save_session_snapshot()
         raise