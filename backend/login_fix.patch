--- playwright_driver.py.orig
+++ playwright_driver.py
@@ -500,6 +500,50 @@
             pass

 async def _is_login_modal_visible(page):
+    sels = ['#J_LoginBox', '.login-box', '.login-dialog', '[id*="login"][class*="dialog"]']
+    for s in sels:
+        try:
+            if await page.locator(s).is_visible(timeout=100):
+                return True
+        except Exception:
+            pass
+    return False
+
+async def _is_logged_in(page):
+    # Heuristic: có avatar/nickname/ô vào "工作台"
+    return await page.evaluate("""
+      () => {
+        const txt = document.body.innerText || "";
+        const hasHi = txt.includes("早上好") || txt.includes("下午好") || txt.includes("晚上好");
+        const hasAvatar = document.querySelector('.icbu-login-avatar, [class*="avatar"], [href*="member"]');
+        const hasWork = document.querySelector('a[href*="work.1688.com"]');
+        return hasHi || !!hasAvatar || !!hasWork;
+      }
+    """)
+
+async def _wait_login_settled(page, settle_ms=800, max_s=30):
+    end = asyncio.get_event_loop().time() + max_s
+    gone_at = None
+    while asyncio.get_event_loop().time() < end:
+        vis = await _is_login_modal_visible(page)
+        if not vis:
+            gone_at = gone_at or asyncio.get_event_loop().time()
+            if asyncio.get_event_loop().time() - gone_at >= settle_ms/1000.0:
+                if await _is_logged_in(page):  # xác nhận đã login
+                    return True
+        else:
+            gone_at = None
+        await asyncio.sleep(0.2)
+    return False
+
 async def _close_overlays(page):
     # đóng vài overlay thường gặp để tránh che click/goto
     for sel in ['.guide-close', '.close-btn', '[aria-label="关闭"]', '.newuser-guide .close', '.pop-close']:
@@ -548,6 +592,46 @@
 async def ensure_login_via_taobao(page, timeout_s: int = 300, next_url: str | None = None, force_show_login: bool = False):
     """
     Login 1688 ổn định: vào 1688.com -> click 登录 -> popup ->
     login thành công -> gỡ guard -> về Work Home (1 lần duy nhất).
     """
+    # chặn popup mở tab lạ
+    page.on("popup", lambda p: asyncio.create_task(p.close()))
+    await page.add_init_script("window.open = () => null;")
+
     WORK_HOME = "https://work.1688.com/?tracelog=login_target_is_blank_1688"
     ctx = page.context

@@ -570,6 +654,15 @@
     await page.goto("https://www.1688.com/", wait_until="domcontentloaded")

+    # nếu chưa login thì mở modal
+    if not await _is_logged_in(page):
+        try:
+            btn = page.locator('text=登录, button:has-text("登录")').first
+            if await btn.is_visible(timeout=1500):
+                await btn.click()
+        except Exception:
+            pass
+
+        ok = await _wait_login_settled(page, settle_ms=800, max_s=min(60, timeout_s))
+        if not ok:
+            return {"ok": False, "reason": "login_not_settled"}
+
     # --- inside ensure_login_via_taobao(...) after goto 1688 and page is idle ---
     # 0) đảm bảo ở homepage và hiển thị vùng nút
     try:
@@ -775,6 +868,27 @@
         await page.goto(WORK_HOME, wait_until="domcontentloaded")
         try:
             await page.wait_for_url(r"^https://work\.1688\.com/", timeout=8000)
@@ -780,20 +894,18 @@
     # 5) Nếu next_url được truyền cho one-shot mode thì xử lý SAU NÀY
     if next_url and not force_show_login:
         await _goto_with_1688_referer(page, next_url)

     return True
+    # lưu session
+    try:
+        await page.context.storage_state(path="state.json")
+    except Exception:
+        pass
+
+    # ghé Work Home 1 lần để server ghi nhận trạng thái
+    try:
+        await page.goto("https://work.1688.com/home/seller.htm", wait_until="domcontentloaded")
+        await page.wait_for_timeout(500)
+    except Exception:
+        pass
+
+    # chuyển tới sản phẩm nếu có
+    if next_url:
+        await page.goto(next_url, wait_until="domcontentloaded")
+        # nếu site cố bật login lại thì kéo về sản phẩm thêm 1 lần
+        if await _is_login_modal_visible(page):
+            await page.goto(next_url, wait_until="domcontentloaded")
+
+    return {"ok": True}

 async def open_chat_from_product_canonical(page, product_url: str, timeout_s: int = 90):
     try:
@@ -1100,6 +1231,25 @@
     raise ValueError(f"Cannot normalize product url: {raw}")
 # ========= Namespace cho state_machine =========
 playwright_driver = SimpleNamespace(
     launch_browser=launch_browser,
     persist_state=persist_state,
     close_browser=close_browser,
     start=start,
     stop=stop,
     ensure_login_via_taobao=ensure_login_via_taobao,
     open_chat_from_product_canonical=open_chat_from_product_canonical,
     send_on_chat_precise_canonical=send_on_chat_precise_canonical,
     wait_for_supplier_reply_canonical=wait_for_supplier_reply_canonical,
     wait_for_chat_ready=wait_for_chat_ready,
     normalize_1688_product_url=normalize_1688_product_url,
     stable_goto_with_referer=stable_goto_with_referer,
+    ensure_chat_ready=ensure_chat_ready,
 )
+
+async def ensure_chat_ready(page, max_s=15):
+    try:
+        box = page.locator('textarea, [contenteditable="true"]').first
+        await box.wait_for(state="visible", timeout=max_s*1000)
+        await box.click()
+        return True
+    except Exception:
+        return False